version: "3.7"

services:
    {%- for key,value in sources.items() %}
    {%- if "postgress" in key -%}
        {% set source_ini = "POSTGRESS" %}
    {%- elif "mysql" in key -%}
        {% set source_ini = "MYSQL" %}
        {% set ROOT_PWD = "mysql" %}
    {% endif -%}
    {{key}}:
        image: {{value.image}}
        container_name: {{key}}
        restart: always
        environment:
            {{source_ini}}_USER: {{value.user}}
            {{source_ini}}_PASSWORD: {{value.password}}
            {%- if "mysql" in key %}
            {{source_ini}}_ROOT_PASSWORD: {{ROOT_PWD}}
            {%- endif %}
        volumes:
            - test-data:/data
            {%- for volume in value.volumes %}
            - {{volume}}
            {%- endfor %}
        ports:
        {%- for port in value.ports %}
            - {{port}}
        {% endfor %}
    {% endfor %}

volumes:
    test-data:
        external: true
{%- for key,source in sources.items() %}
    {{key}}:
{%- endfor %}